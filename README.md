# genotyphi

Assign genotypes to Salmonella Typhi genomes based on VCF or BAM files (mapped to Typhi CT18 reference genome)

For short read data, we recommend using the raw alignments (BAM files) as input (via --bam), since VCFs generated by different pipelines may have filtered out important data at the genotyping loci. Note you also need to supply the reference sequence that was used. If you don't have BAMs or you are really confident in the quality of your SNP calls in existing VCF files, you can provide your own VCFs (generated by read mapping) via --vcf.

For assemblies, we recommend using [ParSNP](http://harvest.readthedocs.org/) to align genomes to the CT18 reference. The resulting multi-sample VCF file(s) can be passed directly to this script via --vcf_parsnp.

## Basic Usage - own VCF

```
python genotyphi.py --ref AL513382 --vcf *vcf > genotypes.txt
```

### Required options

```
--vcf   Path to one or more VCF files, generated by mapping to the Typhi CT18 reference genome (AL513382)
        Note the SNP coordinates used here for genotyping are relative to Typhi CT18 (AL513382) 
        so the input MUST be a VCF obtained via mapping to this reference sequence.

--ref   Name of the Typhi CT18 chromosome reference in your VCF file.
        This is the entry in the first column (#CHROM) of the data part of the file.
        This is necessary in case you have mapped to multiple replicons (e.g. chromosome and
        plasmid) and all the results appear in the same VCF file.
```

### Other options

```
--phred       Minimum phred quality to count a variant call vs CT18 as a true SNP (default 20)

--min_prop    Minimum proportion of reads required to call a SNP (default 0.1)
```

## Basic usage - genotyping from BAM files

## Basic usage - genotyping from genome assemblies

We recommend using [ParSNP](http://harvest.readthedocs.org/) to align genomes to the CT18 reference. The resulting multi-sample VCF file(s) can be passed directly to this script via --vcf_parsnp.

For example:

```
# Download CT18 reference genome

wget ftp://ftp.ncbi.nih.gov/genomes/Bacteria/Salmonella_enterica_serovar_Typhi_CT18_uid57793/NC_003198.fna

mv NC_003198.fna CT18.fasta

# Download two example Typhi genomes for genotyping

wget ftp://ftp.ncbi.nih.gov/genomes/Bacteria/Salmonella_enterica_serovar_Typhi_P_stx_12_uid87001/NC_016832.fna
wget ftp://ftp.ncbi.nih.gov/genomes/Bacteria/Salmonella_enterica_serovar_Typhi_Ty2_uid57973/NC_004631.fna

mkdir genomes/
mv NC_016832.fna genomes/Pstx12.fasta
mv NC_004631.fna genomes/Ty2.fasta

# Use ParSNP to generate variant calls (VCF) for these genomes against the CT18 reference sequence

parsnp -r CT18.fasta -d genomes/ -o output

# Call Typhi genotypes from the resulting VCF

python genotyphi.py --ref 1 --vcf_multi output/parsnp.vcf > genotypes.txt

# Output: P-stx-12 should be called as clade 4.3 (otherwise known as H58), Ty2 should be called as clade 4.1. 
# The 'A' in the Final_call_support indicates the genotype calls were made from assembled data, hence no read support information is available.

File	Final_call	Final_call_support	Subclade	Clade	PrimaryClade	Support_Subclade	Support_Clade	Support_PrimaryClade
Pstx12.fasta	4.3	A		4.3	4			
Ty2.fasta	4.1	A		4.1	4	

```

## Outputs

Output is to standard out, in tab delimited format.

The script works by looking for SNPs that define three nested levels of phylogenetic lineages for S. Typhi: primary clusters, clades and subclades. These are named in the form 1.2.3, which indicates primary cluster 1, clade 1.2, and subclade 1.2.3.

All genotypes implicated by the detected SNPs will be reported (comma separated if multiple are found). 

Usually subclade, clade and primary cluster SNPs will be compatible, i.e. you would expect to see 1.2.3 in the subclade column, 1.2 in the clade column and 1 in the primary clade column.

The first column 'Final_call' indicates the highest resolution genotype (subclade > clade > primary clade) that could be called.

As recombination is extremely rare in S. Typhi, it is unlikely that DNA isolated from a single S. Typhi culture would have high quality SNPs that are compatible with multiple genotypes, or incompatible clade/subclade combinations... therefore if you see this in the output, it is worth investigating further whether you have contaminated sequence data or a genuine recombination. To provide very basic assistance with this the output file indicates, for each genotype-defining SNP detected, the proportion of reads that support the genotype call. A genuine recombinant strain would have p=1 for multiple incompatible SNPs, whereas a mixed DNA sample might have p~0.5. Note that if you are genotyping from assemblies, we have no information on read support to work with; instead you will see an 'A' in the Final_call_support column to indicate this result comes from a genome assembly.

WARNING: Note the reference genome CT18 has the genotype 3.2.1. It is therefore possible that unexpected behaviour (e.g. wrong reference, unspecified reference name, or problems that results in overall poor quality SNP calls in the VCF) can sometimes result in calls of 3.2.1 ... so if you see lots of strains being assigned this genotype, it is worth investigating further.
